const randnum=(e,t)=>Math.round(Math.random()*(t-e)+e);class CannonHelper{constructor(e){this.scene=e}addLights(e){e.shadowMap.enabled=!0,e.shadowMap.type=THREE.PCFSoftShadowMap;const t=new THREE.HemisphereLight(16777147,526368,.8);this.scene.add(t);const o=new THREE.DirectionalLight(14540253,.25,1);o.position.set(3,10,4),o.target.position.set(0,0,0),o.castShadow=!0,this.sun=o,this.scene.add(o)}set shadowTarget(e){void 0!==this.sun&&(this.sun.target=e)}createCannonTrimesh(e){if(!e.isBufferGeometry)return null;const t=e.attributes.position,o=e.attributes.position.array;let n=[];for(let e=0;e<t.count;e++)n.push(e);return new CANNON.Trimesh(o,n)}createCannonConvex(e){if(!e.isBufferGeometry)return null;const t=e.attributes.position,o=e.attributes.position.array,n=[],i=[];let a=[],s=0;for(let e=0;e<t.count;e+=3)n.push(new CANNON.Vec3(o[e],o[e+1],o[e+2])),a.push(s++),3==a.length&&(i.push(a),a=[]);return new CANNON.ConvexPolyhedron(n,i)}addVisual(e,t,o=!1,n=!0){let i;e.name=t,void 0===this.currentMaterial&&(this.currentMaterial=new THREE.MeshLambertMaterial({color:8947848})),void 0===this.settings&&(this.settings={stepFrequency:60,quatNormalizeSkip:2,quatNormalizeFast:!0,gx:0,gy:0,gz:0,iterations:3,tolerance:1e-4,k:1e6,d:3,scene:0,paused:!1,rendermode:"solid",constraints:!1,contacts:!1,cm2contact:!1,normals:!1,axes:!1,particleSize:.1,shadows:!1,aabbs:!1,profiling:!1,maxSubSteps:3},this.particleGeo=new THREE.SphereGeometry(1,16,8),this.particleMaterial=new THREE.MeshLambertMaterial({color:16711680})),e instanceof CANNON.Body&&(i=this.shape2Mesh(e,o,n)),i&&(e.threemesh=i,i.castShadow=o,i.receiveShadow=n,this.scene.add(i))}shape2Mesh(e,t,o){const n=new THREE.Object3D,i=this.currentMaterial,a=this;let s=0;return e.shapes.forEach((function(r){let c,l,h,d,p;switch(r.type){case CANNON.Shape.types.SPHERE:const e=new THREE.SphereGeometry(r.radius,8,8);c=new THREE.Mesh(e,i);break;case CANNON.Shape.types.PARTICLE:c=new THREE.Mesh(a.particleGeo,a.particleMaterial);const t=this.settings;c.scale.set(t.particleSize,t.particleSize,t.particleSize);break;case CANNON.Shape.types.PLANE:l=new THREE.PlaneGeometry(100,100,4,4),c=new THREE.Object3D;const o=new THREE.Object3D,n=new THREE.Mesh(l,groundMaterial);n.scale.set(1,1,1),o.add(n),c.add(o);break;case CANNON.Shape.types.BOX:const s=new THREE.BoxGeometry(2*r.halfExtents.x,2*r.halfExtents.y,2*r.halfExtents.z);c=new THREE.Mesh(s,new THREE.MeshLambertMaterial({color:8947848,wireframe:!0,transparent:!0,opacity:0}));break;case CANNON.Shape.types.CONVEXPOLYHEDRON:const f=new THREE.Geometry;r.vertices.forEach((function(e){f.vertices.push(new THREE.Vector3(e.x,e.y,e.z))})),r.faces.forEach((function(e){const t=e[0];for(let o=1;o<e.length-1;o++){const n=e[o],i=e[o+1];f.faces.push(new THREE.Face3(t,n,i))}})),f.computeBoundingSphere(),f.computeFaceNormals(),c=new THREE.Mesh(f,i);break;case CANNON.Shape.types.HEIGHTFIELD:l=new THREE.Geometry,h=new CANNON.Vec3,d=new CANNON.Vec3,p=new CANNON.Vec3;for(let e=0;e<r.data.length-1;e++)for(let t=0;t<r.data[e].length-1;t++)for(let o=0;o<2;o++){r.getConvexTrianglePillar(e,t,0===o),h.copy(r.pillarConvex.vertices[0]),d.copy(r.pillarConvex.vertices[1]),p.copy(r.pillarConvex.vertices[2]),h.vadd(r.pillarOffset,h),d.vadd(r.pillarOffset,d),p.vadd(r.pillarOffset,p),l.vertices.push(new THREE.Vector3(h.x,h.y,h.z),new THREE.Vector3(d.x,d.y,d.z),new THREE.Vector3(p.x,p.y,p.z));var m=l.vertices.length-3;l.faces.push(new THREE.Face3(m,m+1,m+2))}l.computeBoundingSphere(),l.computeFaceNormals();function w(e,t,o,n){e.computeBoundingBox();for(var i,a,s=e.boundingBox,r=(new THREE.Vector3).subVectors(s.max,s.min),c=["a","b","c"],l=new THREE.Vector3,h=0,d=0;d<t.length-1;d++)for(var p=t[d+1].stop-t[d].stop,m=0;m<e.faces.length;m++){i=e.faces[m];for(var E=0;E<3;E++)if(a=e.vertices[i[c[E]]],h=l.subVectors(a,s.min).divide(r)[o],n&&(h=1-h),h>=t[d].stop&&h<=t[d+1].stop){var u=(h-t[d].stop)/p;i.vertexColors[E]=t[d].color.clone().lerp(t[d+1].color,u)}}}w(l,[{stop:0,color:new THREE.Color("#270059")},{stop:.25,color:new THREE.Color("#6225E6")},{stop:.5,color:new THREE.Color("#8225e6")},{stop:.75,color:new THREE.Color("#a043ed")},{stop:1,color:new THREE.Color("#f1f3f4")}],"z",!0);var E=new THREE.MeshLambertMaterial({vertexColors:THREE.VertexColors,wireframe:!1});c=new THREE.Mesh(l,E);break;case CANNON.Shape.types.TRIMESH:l=new THREE.Geometry,h=new CANNON.Vec3,d=new CANNON.Vec3,p=new CANNON.Vec3;for(let e=0;e<r.indices.length/3;e++){r.getTriangleVertices(e,h,d,p),l.vertices.push(new THREE.Vector3(h.x,h.y,h.z),new THREE.Vector3(d.x,d.y,d.z),new THREE.Vector3(p.x,p.y,p.z));var u=l.vertices.length-3;l.faces.push(new THREE.Face3(u,u+1,u+2))}l.computeBoundingSphere(),l.computeFaceNormals(),c=new THREE.Mesh(l,MutationRecordaterial);break;default:throw"Visual type not recognized: "+r.type}c.receiveShadow=o,c.castShadow=t,c.traverse((function(e){e.isMesh&&(e.castShadow=t,e.receiveShadow=o)}));var f=e.shapeOffsets[s],w=e.shapeOrientations[s++];c.position.set(f.x,f.y,f.z),c.quaternion.set(w.x,w.y,w.z,w.w),n.add(c)})),n}updateBodies(e){e.bodies.forEach((function(e){null!=e.threemesh&&(e.threemesh.position.copy(e.position),e.threemesh.quaternion.copy(e.quaternion))}))}}var scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.01,1e5);camera.position.set(3,1.4,-3),camera.lookAt(scene.position);const container=document.getElementById("info");renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setSize(container.offsetWidth,container.offsetHeight),renderer.shadowMap.enabled=!0,renderer.shadowMapSoft=!0,renderer.shadowMapType=THREE.PCFShadowMap,document.getElementById("info").appendChild(renderer.domElement);var debug=!0,debugPhysics=!0,fixedTimeStep=1/60,helper=new CannonHelper(scene),physics={};const world=new CANNON.World;world.broadphase=new CANNON.SAPBroadphase(world),world.gravity.set(0,-10,0),world.defaultContactMaterial.friction=0;const groundMaterial=new CANNON.Material("groundMaterial"),wheelMaterial=new CANNON.Material("wheelMaterial"),wheelGroundContactMaterial=new CANNON.ContactMaterial(wheelMaterial,groundMaterial,{friction:0,restitution:0,contactEquationStiffness:1e3});world.addContactMaterial(wheelGroundContactMaterial),(light=new THREE.DirectionalLight(new THREE.Color("white"),.7)).position.set(1,1,1).normalize(),scene.add(light),window.addEventListener("resize",(function(){var e=container.offsetWidth,t=container.offsetWidth;renderer.setSize(e,t),camera.aspect=e/t,camera.updateProjectionMatrix()}));var SCALE=2,hTilt=new THREE.ShaderPass(THREE.HorizontalTiltShiftShader);hTilt.enabled=!1,hTilt.uniforms.h.value=4/(SCALE*container.offsetHeight);var renderPass=new THREE.RenderPass(scene,camera),effectCopy=new THREE.ShaderPass(THREE.CopyShader);effectCopy.renderToScreen=!0;var composer=new THREE.EffectComposer(renderer);composer.addPass(renderPass),composer.addPass(hTilt),composer.addPass(effectCopy);var controls=new function(){this.hTilt=!1,this.hTiltR=.5,this.onChange=function(){hTilt.enabled=controls.hTilt,hTilt.uniforms.r.value=controls.hTiltR}},gui=new dat.GUI;gui.add(controls,"hTilt").onChange(controls.onChange),gui.add(controls,"hTiltR",0,1).onChange(controls.onChange),document.querySelector('.dg .c input[type="checkbox"]').click(),dat.GUI.toggleHide(),Object.defineProperties(THREE.Object3D.prototype,{x:{get:function(){return this.position.x},set:function(e){this.position.x=e}},y:{get:function(){return this.position.y},set:function(e){this.position.y=e}},z:{get:function(){return this.position.z},set:function(e){this.position.z=e}},rotationZ:{get:function(){return this.rotation.x},set:function(e){this.rotation.x=e}},rotationY:{get:function(){return this.rotation.y},set:function(e){this.rotation.y=e}},rotationX:{get:function(){return this.rotation.z},set:function(e){this.rotation.z=e}}}),(geometry=new THREE.BoxBufferGeometry(.5,1,.5)).applyMatrix((new THREE.Matrix4).makeTranslation(0,.5,0));var light,material=new THREE.MeshNormalMaterial({transparent:!0,opacity:0});mesh=new THREE.Mesh(geometry,material),scene.add(mesh),(light=new THREE.DirectionalLight(new THREE.Color("white"),.5)).position.set(0,1,0),light.castShadow=!0,light.target=mesh,mesh.add(light);var clip1,clip2,clip3,mixers=[],loader=new THREE.GLTFLoader;loader.load("https://raw.githubusercontent.com/baronwatts/models/master/astronaut.glb",(function(e){e.scene.traverse((function(e){e instanceof THREE.Mesh&&(e.castShadow=!0,e.material.side=THREE.DoubleSide)}));var t=e.scene;t.position.set(0,-.1,0),t.scale.set(.25,.25,.25),mesh.add(t);const o=new THREE.SpotLight(16777215,1);o.position.set(50,10,5),o.angle=Math.PI/2,scene.add(o);var n=new THREE.AnimationMixer(t);clip1=n.clipAction(e.animations[0]),clip2=n.clipAction(e.animations[1]),mixers.push(n)}));var check,sizeX=128,sizeY=128,minHeight=0,maxHeight=60,startPosition=new CANNON.Vec3(0,maxHeight-3,.5*sizeY-10),img2matrix=function(){"use strict";return{fromImage:e,fromUrl:function(t,o,n,i,a){return function(){return new Promise((function(s,r){var c=new Image;c.crossOrigin="anonymous",c.onload=function(){var t=e(c,o,n,i,a);s(t)},c.src=t}))}}};function e(e,t,o,n,i){var a,s;t|=0,o|=0;var r,c,l=[],h=document.createElement("canvas"),d=h.getContext("2d"),p=i-n;for(h.width=t,h.height=o,d.drawImage(e,0,0,t,o),r=d.getImageData(0,0,t,o).data,a=0;a<o;a=a+1|0)for(l.push([]),s=0;s<t;s=s+1|0)c=r[4*(a*o+s)]/255*p+n,l[a].push(c);return l}}();Promise.all([img2matrix.fromUrl("https://upload.wikimedia.org/wikipedia/commons/5/57/Heightmap.png",sizeX,sizeY,minHeight,maxHeight)()]).then((function(e){var t=e[0];const o=new CANNON.Heightfield(t,{elementSize:10}),n=new CANNON.Body({mass:0});n.addShape(o),n.position.set(-sizeX*o.elementSize/2,-10,sizeY*o.elementSize/2),n.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2),world.add(n),helper.addVisual(n,"landscape");var i=new THREE.CylinderGeometry(0,1,5,1.5);i.translate(0,0,0),i.rotateX(Math.PI/2),raycastHelperMesh=new THREE.Mesh(i,new THREE.MeshNormalMaterial),scene.add(raycastHelperMesh),check=function(){var e=new THREE.Raycaster(mesh.position,new THREE.Vector3(0,-1,0)).intersectObject(n.threemesh.children[0]);e.length>0&&(raycastHelperMesh.position.set(0,0,0),raycastHelperMesh.lookAt(e[0].face.normal),raycastHelperMesh.position.copy(e[0].point)),mesh.position.y=e&&e[0]?e[0].point.y+.1:30;var t=new THREE.Raycaster(flagLocation.position,new THREE.Vector3(0,-1,0)).intersectObject(n.threemesh.children[0]);flagLocation.position.y=t&&t[0]?t[0].point.y+.5:30,flagLight.position.y=flagLocation.position.y+50,flagLight.position.x=flagLocation.position.x+5,flagLight.position.z=flagLocation.position.z}})),(geometry=new THREE.BoxBufferGeometry(.35,2,.15)).applyMatrix((new THREE.Matrix4).makeTranslation(0,1,0));material=new THREE.MeshNormalMaterial({transparent:!0,opacity:0});flagLocation=new THREE.Mesh(geometry,material),scene.add(flagLocation),flagLocation.position.x=-90,flagLocation.position.z=70,flagLocation.rotateY(Math.PI);var geometry=new THREE.CylinderGeometry(.03,.03,4,32),cylinder=(material=new THREE.MeshPhongMaterial({color:new THREE.Color("gray")}),new THREE.Mesh(geometry,material));cylinder.geometry.center(),cylinder.castShadow=!0,flagLocation.add(cylinder);var pointflagLight=new THREE.PointLight(new THREE.Color("purple"),1.5,5);pointflagLight.position.set(0,0,0),flagLocation.add(pointflagLight);var flagLight=new THREE.DirectionalLight(new THREE.Color("white"),0);flagLight.position.set(0,0,0),flagLight.castShadow=!0,flagLight.target=flagLocation,scene.add(flagLight);var texture=(new THREE.TextureLoader).load("");plane=new THREE.Mesh(new THREE.PlaneGeometry(600,430,20,20,!0),new THREE.MeshBasicMaterial({map:texture,side:THREE.DoubleSide})),plane.scale.set(.0025,.0025,.0025),plane.position.set(0,1.5,0),plane.position.x=.75,plane.castShadow=!0,flagLocation.add(plane);const loader2=new THREE.FontLoader;loader2.load("./font/Hack_Bold.json",(function(e){const t=new THREE.TextGeometry("PILLAP",{font:e,size:75,height:75});var o=new THREE.Mesh(t,[new THREE.MeshPhongMaterial({color:16777215})]);o.scale.set(.1,.1,.1),o.position.x=-20,o.position.y=13,o.position.z=90,o.rotation.y=700,scene.add(o),o.addEventListener("click",(function(){}));const n=new THREE.TextGeometry("GITHUB",{font:e,size:80,height:80});var i=new THREE.Mesh(n,[new THREE.MeshPhongMaterial({color:16777215})]);i.scale.set(.1,.1,.1),i.position.x=-90,i.position.y=4,i.position.z=90,i.rotation.y=800,scene.add(i);const a=new THREE.DirectionalLight(6432230,.1);a.position.set(-80,50,50),scene.add(a)}));class JoyStick{constructor(e){const t=document.getElementById("info"),o=document.createElement("div");o.style.cssText="position:absolute; left: 50%; bottom:40px; width:80px; height:80px; background:rgba(126, 126, 126, 0.5); border:#444 solid medium; border-radius:50%; transform:translateX(-50%);";const n=document.createElement("div");if(n.style.cssText="position:absolute; left: 17px; top: 17px; width: 40px; height: 40px; border-radius: 50%; background: #fff;",o.appendChild(n),t.appendChild(o),this.domElement=n,this.maxRadius=e.maxRadius||40,this.maxRadiusSquared=this.maxRadius*this.maxRadius,this.onMove=e.onMove,this.game=e.game,this.origin={left:this.domElement.offsetLeft,top:this.domElement.offsetTop},this.rotationDamping=e.rotationDamping||.06,this.moveDamping=e.moveDamping||.01,null!=this.domElement){const e=this;"ontouchstart"in window?this.domElement.addEventListener("touchstart",(function(t){e.tap(t)})):this.domElement.addEventListener("mousedown",(function(t){e.tap(t)}))}}getMousePosition(e){return{x:e.targetTouches?e.targetTouches[0].pageX:e.clientX,y:e.targetTouches?e.targetTouches[0].pageY:e.clientY}}tap(e){e=e||window.event,this.offset=this.getMousePosition(e);const t=this;"ontouchstart"in window?(document.ontouchmove=function(e){t.move(e)},document.ontouchend=function(e){t.up(e)}):(document.onmousemove=function(e){t.move(e)},document.onmouseup=function(e){t.up(e)})}move(e){e=e||window.event;const t=this.getMousePosition(e);let o=t.x-this.offset.x,n=t.y-this.offset.y;const i=o*o+n*n;if(i>this.maxRadiusSquared){const e=Math.sqrt(i);o/=e,n/=e,o*=this.maxRadius,n*=this.maxRadius}this.domElement.style.top=`${n+this.domElement.clientHeight/2}px`,this.domElement.style.left=`${o+this.domElement.clientWidth/2}px`;const a=-(n-this.origin.top+this.domElement.clientHeight/2)/this.maxRadius,s=(o-this.origin.left+this.domElement.clientWidth/2)/this.maxRadius;null!=this.onMove&&this.onMove.call(this.game,a,s)}up(e){"ontouchstart"in window?(document.ontouchmove=null,document.touchend=null):(document.onmousemove=null,document.onmouseup=null),this.domElement.style.top=`${this.origin.top}px`,this.domElement.style.left=`${this.origin.left}px`,this.onMove.call(this.game,0,0)}}var js={forward:0,turn:0},joystick=new JoyStick({onMove:joystickCallback});function joystickCallback(e,t){js.forward=e,js.turn=-t}function updateDrive(e=js.forward,t=js.turn){const o=.15*e,n=.05*t;0!=e?(mesh.translateZ(o),clip2&&clip2.play(),clip1&&clip1.stop()):(clip2&&clip2.stop(),clip1&&clip1.play()),mesh.rotateY(n)}var followCam=new THREE.Object3D;function updateCamera(){followCam&&(camera.position.lerp(followCam.getWorldPosition(new THREE.Vector3),.05),camera.lookAt(mesh.position.x,mesh.position.y+.5,mesh.position.z))}followCam.position.copy(camera.position),scene.add(followCam),followCam.parent=mesh;var lastTime,clock=new THREE.Clock;!function e(){requestAnimationFrame(e),updateCamera(),updateDrive(),renderer.render(scene,camera);let t=clock.getDelta();mixers.map((e=>e.update(t)));const o=Date.now();void 0===lastTime&&(lastTime=o);const n=(Date.now()-lastTime)/1e3;lastTime=o,world.step(fixedTimeStep,n),helper.updateBodies(world),check&&check()}();